================================================================================
                        TESTING AND DEBUGGING METHODS
                        SDN Final Project - Fall 2025
================================================================================

Part 3: Layer-3 Shortest Path Routing Testing
================================================================================

1. Basic Connectivity Testing
-----------------------------
   Test Command: pingall

   Steps:
   a) Start Floodlight controller:
      $ java -jar FloodlightWithApps.jar -cf l3routing.prop

   b) Start Mininet with various topologies:
      $ sudo ./run_mininet.py single,3
      $ sudo ./run_mininet.py linear,3
      $ sudo ./run_mininet.py tree,2
      $ sudo ./run_mininet.py triangle
      $ sudo ./run_mininet.py someloops
      $ sudo ./run_mininet.py mesh,5
      $ sudo ./run_mininet.py assign1

   c) In Mininet CLI:
      mininet> pingall

   Expected Result: 0% packet loss for all topologies

2. Flow Table Verification
--------------------------
   Test Command: ovs-ofctl dump-flows

   Steps:
   a) After starting controller and Mininet, run:
      $ sudo ovs-ofctl -O OpenFlow13 dump-flows s1
      $ sudo ovs-ofctl -O OpenFlow13 dump-flows s2
      (repeat for all switches)

   Expected Result: Flow rules matching destination IP addresses with
   output actions to appropriate ports

3. Link Failure Testing
-----------------------
   Test Commands: link down/up

   Steps:
   a) Start with triangle or someloops topology
   b) Verify initial connectivity:
      mininet> pingall
   c) Take down a link:
      mininet> link s1 s2 down
   d) Verify connectivity is maintained (if alternate path exists):
      mininet> pingall
   e) Bring link back up:
      mininet> link s1 s2 up
   f) Verify connectivity:
      mininet> pingall

   Expected Result: Network should automatically reroute traffic

4. Host Movement Testing
------------------------
   Steps:
   a) Take down link between switch and host:
      mininet> link s1 h1 down
   b) Verify host is unreachable
   c) Bring link back up:
      mininet> link s1 h1 up
   d) Verify host is reachable again

5. Switch Removal Testing
-------------------------
   Steps:
   a) In a separate terminal (not Mininet):
      $ sudo ovs-vsctl del-br s2
   b) Verify remaining hosts can still communicate (if path exists)


Part 4: Load Balancer Testing
================================================================================

1. Basic Load Balancer Setup
----------------------------
   Steps:
   a) Start controller with load balancer:
      $ java -jar FloodlightWithApps.jar -cf loadbalancer.prop

   b) Start Mininet:
      $ sudo ./run_mininet.py single,3

2. ARP Resolution Testing
-------------------------
   Steps:
   a) From a host, ARP for virtual IP:
      mininet> h1 arping -c 1 10.0.100.1

   Expected Result: Should receive ARP reply with virtual MAC (00:00:01:00:00:01)

3. HTTP Load Balancing Testing
------------------------------
   Steps:
   a) Start web servers on backend hosts (automatically done by run_mininet.py)
   b) Issue HTTP requests from client:
      mininet> h1 curl 10.0.100.1
      mininet> h1 curl 10.0.100.1
      mininet> h1 curl 10.0.100.1

   Expected Result: Requests should be distributed round-robin to h2 and h3

4. Connection-Specific Rule Verification
----------------------------------------
   Steps:
   a) Issue a curl request
   b) Check flow tables:
      $ sudo ovs-ofctl -O OpenFlow13 dump-flows s1

   Expected Result: Should see connection-specific rules with:
   - Higher priority than default rules
   - IP/MAC rewrite actions
   - 20 second idle timeout

5. TCP Reset Testing
--------------------
   Steps:
   a) Wait for connection-specific rules to timeout (20+ seconds of idle)
   b) Try to send non-SYN TCP packet to virtual IP

   Expected Result: Should receive TCP RST

6. Packet Capture Debugging
---------------------------
   Tool: tcpdump

   Steps:
   a) In Mininet, run on a host:
      mininet> h1 tcpdump -v -n -i h1-eth0 &
   b) Generate traffic and observe packet flow


Part 3 Extra Credit: Spanning Tree and ECMP Testing
================================================================================

1. Spanning Tree Testing (Loop-Free Broadcast)
----------------------------------------------
   Purpose: Verify broadcast traffic doesn't cause storms in looped topologies

   Steps:
   a) Start Floodlight controller:
      $ java -jar FloodlightWithApps.jar -cf l3routing.prop

   b) Start Mininet with a looped topology:
      $ sudo ./run_mininet.py someloops
      (or)
      $ sudo ./run_mininet.py triangle

   c) Check controller logs for spanning tree computation:
      Look for: "Spanning tree edge: s1:X <-> s2:Y"
      Look for: "Spanning tree computed successfully"

   d) Verify broadcast rules are installed:
      $ sudo ovs-ofctl -O OpenFlow13 dump-flows s1 | grep "dl_dst=ff:ff:ff:ff:ff:ff"

   Expected Result:
   - Broadcast rules with multiple output ports (spanning tree ports only)
   - No broadcast loops (packets don't circulate infinitely)
   - ARP resolution works correctly

   e) Test ARP works (uses broadcast):
      mininet> h1 ping -c 1 h2
      (First ping triggers ARP which uses broadcast rules)

2. ECMP Testing (Equal-Cost Multi-Path)
---------------------------------------
   Purpose: Verify traffic is distributed across multiple equal-cost paths

   Steps:
   a) Start Floodlight controller:
      $ java -jar FloodlightWithApps.jar -cf l3routing.prop

   b) Start Mininet with a topology that has multiple paths (e.g., mesh):
      $ sudo ./run_mininet.py mesh,3

   c) Check controller logs for ECMP path detection:
      Look for: "ECMP: Installing 2 paths from sX to host Y"

   d) Verify ECMP rules are installed:
      $ sudo ovs-ofctl -O OpenFlow13 dump-flows s1

   Expected Result: Should see rules with:
   - TCP protocol match (nw_proto=6)
   - TCP destination port match (tp_dst=0 for even, tp_dst=1 for odd)
   - Higher priority than default rules (priority > 1)
   - Different output ports for different TCP port matches

   e) Test ECMP functionality with TCP traffic:
      mininet> h1 curl h2:80      (uses even port path if 80 is even)
      mininet> h1 curl h2:81      (uses odd port path if 81 is odd)

   f) Alternative: Use iperf to generate TCP traffic:
      mininet> h2 iperf -s &
      mininet> h1 iperf -c h2 -p 5001

3. Verifying Spanning Tree Prevents Broadcast Storms
----------------------------------------------------
   Steps:
   a) Start with someloops topology (has multiple loops)
   b) Run pingall to verify connectivity:
      mininet> pingall

   c) Check packet counts:
      $ sudo ovs-ofctl dump-ports s1 -O OpenFlow13

   Expected Result:
   - 0% packet loss with pingall
   - No excessive packet counts (would indicate broadcast storm)
   - ARP completes quickly (no timeout)

4. ECMP Path Verification with tcpdump
--------------------------------------
   Steps:
   a) Start with mesh,3 topology
   b) On switch s2, monitor traffic:
      (In separate terminal)
      $ sudo tcpdump -i s2-eth1 -n

   c) Generate traffic with different TCP ports:
      mininet> h1 nc -p 80 h3 8080 &
      mininet> h1 nc -p 81 h3 8081 &

   Expected Result:
   - Traffic should be visible on different paths based on TCP port
   - Even ports use one path, odd ports use another


Debugging Tips
================================================================================

1. Always restart Floodlight when switching topologies:
   - Stop Mininet: exit
   - Clean Mininet: sudo mn -c
   - Stop Floodlight: Ctrl+C
   - Restart Floodlight
   - Restart Mininet

2. Check controller logs for errors and warnings

3. Use ovs-ofctl to verify flow rules are installed correctly

4. Use tcpdump to trace packet flow through the network

5. Verify all hosts are discovered by checking Floodlight logs for
   "Host added" messages

6. For Extra Credit features:
   - Check logs for "Spanning tree" messages
   - Check logs for "ECMP" messages
   - Verify broadcast rules match dl_dst=ff:ff:ff:ff:ff:ff
   - Verify ECMP rules match nw_proto=6 (TCP)
